{% extends 'tasks/base.html' %}
{% block content %}

{# ğŸ”” Display Django messages only if present #}
{% if messages %}
  {% for message in messages %}
    <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
      {{ message }}
      <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
  {% endfor %}
{% endif %}



{% if urgent_tasks.exists %}
  <div class="alert alert-danger">
    âš ï¸ Reminder: You have {{ urgent_tasks.count }} task(s) due soon!
  </div>
{% endif %}
<h2 class="mb-3">
    Welcome, {{ user.username }} ğŸ‘‹
</h2>

<h2 class="mb-3">Your Tasks</h2>
<a href="{% url 'task_create' %}" class="btn btn-primary mb-3">â• Create New Task</a>

<table class="table table-dark table-striped table-hover">
  <thead class="table-secondary text-dark">
    <tr>
      <th>Title</th>
      <th>Priority</th>
      <th>Status</th>
      <th>Due</th>
      <th>Completed</th>
       <th>Actions</th> 
    </tr>
  </thead>
  <tbody>
    {% for task in tasks %}
    <tr id="task-row-{{ task.id }}">
      <td>{{ task.title }}</td>
      <td>
        {% if task.priority == "High" %}
          <span class="badge bg-danger">{{ task.priority }}</span>
        {% elif task.priority == "Medium" %}
          <span class="badge bg-warning text-dark">{{ task.priority }}</span>
        {% else %}
          <span class="badge bg-success">{{ task.priority }}</span>
        {% endif %}
      </td>
      <td>{{ task.status }}</td>
      <td>{{ task.due_date }}</td>
      <td>
        <input type="checkbox" class="complete-task" data-task-id="{{ task.id }}">
      </td>
       <td>
        <a href="{% url 'task_update' task.id %}" class="btn btn-sm btn-warning"<a>Update</a>
      </td>
    </tr>
    {% empty %}
    <tr><td colspan="6" class="text-center">No tasks yet</td></tr>
    {% endfor %}
  </tbody>
</table>
<div class="mb-3">
  <a href="{% url 'send_reminder' %}" class="btn btn-primary">
    Send Reminder Now
  </a>
</div>

<script>
document.addEventListener("DOMContentLoaded", function() {
  document.querySelectorAll(".complete-task").forEach(function(checkbox) {
    checkbox.addEventListener("change", function() {
      if (this.checked) {
        let taskId = this.getAttribute("data-task-id");

        // ğŸ”” Confirmation box
        if (!confirm("âš ï¸ Are you sure you want to delete this task?")) {
          this.checked = false;  // agar user cancel kare to checkbox uncheck
          return;
        }

        fetch(`/tasks/delete/${taskId}/`, {
          method: "POST",
          headers: {
  "X-CSRFToken": document.querySelector('meta[name="csrf-token"]').getAttribute("content"),
  "Content-Type": "application/json",
},
        })
        .then(response => {
          if (response.ok) {
            // Row ko fade-out effect ke saath delete karte hain
            let row = document.getElementById("task-row-" + taskId);
            row.style.transition = "opacity 0.5s";
            row.style.opacity = "0";
            setTimeout(() => row.remove(), 500);
          } else {
            alert("âŒ Error deleting task!");
            this.checked = false;  // error aaye to wapas uncheck
          }
        });
      }
    });
  });
});
</script>
{% endblock %}